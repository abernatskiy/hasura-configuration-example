# Hasura-based squid

This is an example squid that uses a dedicated Hasura instance to serve GraphQL.

Requirements: NodeJS v20 or newer, Git, Docker, [Squid CLI](https://docs.sqd.dev/squid-cli/installation/)

## Preparing the squid

```bash
git clone https://github.com/subsquid-labs/squid-hasura-example
cd squid-hasura-example
npm ci
npm run build
```

## Running the squid

```bash
docker compose up -d
sqd run . -m manifests/local.yml
```
You can now visit the [Hasura console](http://localhost:8080/console), login with the admin password `testing` and observe the entities and relationships in the GraphiQL playground. Alternatively, just run the following test query at [http://localhost:8080/v1/graphql](http://localhost:8080/v1/graphql):
```graphql
query {
  burn(limit: 10) {
    id
    value
    address
  }
}
```

## Deploying the squid

To deploy the squid to [SQD Cloud](https://docs.sqd.dev/cloud) create the admin password [secret](https://docs.sqd.dev/cloud/resources/env-variables/#secrets) with
```bash
sqd secrets:set HASURA_GRAPHQL_ADMIN_SECRET the_secret_phrase
```
then run
```bash
sqd deploy . -m manifests/cloud.yml
```

## Automatic metadata generation

The autogenerated metadata file `hasura_metadata.json` tracks all tables and relationships in the database schema defined by TypeORM models (`src/models`) and gives the `public` role the permission to read all columns in these tables. Apply it with
```bash
npx squid-hasura-configuration apply
```

You may want to regenerate it after changing your schema. Here's how:
1. Edit `schema.graphql`.
2. Regenerate the TypeORM models with `npx squid-typeorm-codegen`.
3. Compile the code with `npm run build`.
4. Finally, regenerate the metadata file with
   ```bash
   npx squid-hasura-configuration regenerate
   ```

`hasura_metadata.json` is compatible with the standard metadata export / import mechanics available in web GUI via "Settings > Metadata Actions". Configure your Hasura instance any way you want, export the configuration to `hasura_metadata.json`, then restore it with `npx squid-hasura-configuration apply` after squid resets.

> [!IMPORTANT]
> Regenerating `hasura_metadata.json` removes any modifications you might have made via metadata exporting. So, it is advisable that you finalize your schema before you begin any manual API fine-tuning.

## Environment variables

Hasura container and the configuration tool use the following variables:

- `HASURA_GRAPHQL_ADMIN_SECRET` must be defined - either via `.env` (for local runs) or via [SQD Cloud secrets](https://docs.sqd.dev/cloud/resources/env-variables/#secrets) (see `manifests/cloud.yml`)
- `HASURA_GRAPHQL_UNAUTHORIZED_ROLE` must be defined and set to `public`. If you change the role name, update `.env`, all manifests and [regenerate the Hasura config](#automatic-configuration).
- `HASURA_GRAPHQL_ENDPOINT` is used by the configuration tool to connect to Hasura. It defaults to `http://localhost:8080`.
